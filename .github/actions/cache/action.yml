# Copyright 2024 The Fuchsia Authors
#
# Licensed under a BSD-style license <LICENSE-BSD>, Apache License, Version 2.0
# <LICENSE-APACHE or https://www.apache.org/licenses/LICENSE-2.0>, or the MIT
# license <LICENSE-MIT or https://opensource.org/licenses/MIT>, at your option.
# This file may not be copied, modified, or distributed except according to
# those terms.

name: Cache
description: "Caches cargo and rustup dependencies"
inputs:
  mode:
    description: "restore or generate"
    default: "restore"
  run:
    description: "Commands to run to populate cache (only for generate mode)"
    default: ""
runs:
  using: composite
  steps:
    - name: Restore Cache
      if: inputs.mode == 'restore'
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      id: cache
      with:
        path: ~/.cargo/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Check Cache (Generate Mode)
      if: inputs.mode == 'generate'
      id: check
      shell: bash
      env:
        RUNNER_OS: ${{ runner.os }}
        CARGO_TOML_HASH: ${{ hashFiles('**/Cargo.toml') }}
        GH_TOKEN: ${{ github.token }}
      run: |
        CACHE_KEY="${RUNNER_OS}-cargo-${CARGO_TOML_HASH}"
        if gh cache list --key "$CACHE_KEY" --limit 1 | grep -q "$CACHE_KEY"; then
          echo "cache-hit=true" >> $GITHUB_OUTPUT
        else
          echo "cache-hit=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Commands (Generate Mode)
      if: inputs.mode == 'generate' && steps.check.outputs.cache-hit != 'true'
      shell: bash
      env:
        RUN_COMMANDS: ${{ inputs.run }}
      run: |
        echo "$RUN_COMMANDS" > run_commands.sh
        source run_commands.sh

    - name: Save Cache (Generate Mode)
      if: inputs.mode == 'generate' && steps.check.outputs.cache-hit != 'true'
      uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: ~/.cargo/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
